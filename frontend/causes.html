<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Program Donasi - DariKita</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .hero-gradient {
        background: linear-gradient(
          135deg,
          #1e40af 0%,
          #3b82f6 50%,
          #60a5fa 100%
        );
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo -->
          <a href="index.html" class="flex items-center">
            <div
              class="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-heart text-white text-lg"></i>
            </div>
            <span
              class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-blue-700 bg-clip-text text-transparent"
            >
              DariKita
            </span>
          </a>

          <!-- Navigation Links -->
          <div class="hidden md:flex items-center space-x-8">
            <a
              href="index.html"
              class="text-gray-700 hover:text-blue-600 transition-colors font-medium"
            >
              Beranda
            </a>
            <a
              href="causes.html"
              class="text-blue-600 font-bold border-b-2 border-blue-600"
            >
              Program
            </a>
            <a
              href="index.html#cara-kerja"
              class="text-gray-700 hover:text-blue-600 transition-colors font-medium"
            >
              Cara Kerja
            </a>
            <a
              href="index.html#tentang"
              class="text-gray-700 hover:text-blue-600 transition-colors font-medium"
            >
              Tentang Kami
            </a>
          </div>

          <!-- Auth Buttons -->
          <div class="flex items-center space-x-4" id="auth-buttons">
            <a
              href="login.html"
              class="text-blue-600 hover:text-blue-700 font-medium transition-colors"
            >
              Masuk
            </a>
            <a
              href="register.html"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all font-medium"
            >
              Daftar
            </a>
          </div>

          <!-- User Menu (when logged in) -->
          <div class="hidden items-center space-x-4" id="user-menu">
            <a
              href="dashboard.html"
              class="text-gray-700 hover:text-blue-600 transition-colors font-medium"
            >
              <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <button
              id="logout-btn"
              class="text-red-600 hover:text-red-700 transition-colors font-medium"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>Keluar
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-gradient text-white py-16">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center fade-in-up"
      >
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Program Donasi UMKM</h1>
        <p class="text-xl text-blue-100 max-w-2xl mx-auto">
          Pilih program yang ingin Anda dukung untuk membantu UMKM Indonesia
          berkembang
        </p>
      </div>
    </section>

    <!-- Filter & Search Section -->
    <section class="bg-white shadow-sm sticky top-16 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <!-- Search -->
          <div class="flex-1 max-w-md">
            <div class="relative">
              <input
                type="text"
                id="search-input"
                placeholder="Cari program..."
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <i
                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-3">
            <!-- Category Filter -->
            <select
              id="category-filter"
              class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
            >
              <option value="">Semua Kategori</option>
              <option value="pendidikan">Pendidikan</option>
              <option value="kesehatan">Kesehatan</option>
              <option value="sosial">Sosial</option>
              <option value="bencana">Bencana</option>
              <option value="lingkungan">Lingkungan</option>
              <option value="infrastruktur">Infrastruktur</option>
              <option value="lainnya">Lainnya</option>
            </select>

            <!-- Status Filter -->
            <select
              id="status-filter"
              class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
            >
              <option value="">Semua Status</option>
              <option value="active" selected>Aktif</option>
              <option value="completed">Selesai</option>
            </select>

            <!-- Sort -->
            <select
              id="sort-filter"
              class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
            >
              <option value="newest">Terbaru</option>
              <option value="oldest">Terlama</option>
              <option value="most-funded">Dana Terbanyak</option>
              <option value="urgent">Paling Mendesak</option>
            </select>
          </div>
        </div>

        <!-- Active Filters Display -->
        <div id="active-filters" class="mt-4 flex flex-wrap gap-2 hidden">
          <!-- Active filter tags will appear here -->
        </div>
      </div>
    </section>

    <!-- Programs Section -->
    <section class="py-12 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Results Info -->
        <div class="mb-6 flex items-center justify-between">
          <p id="results-info" class="text-gray-600">
            <i class="fas fa-spinner fa-spin mr-2"></i>Memuat program...
          </p>
          <button
            onclick="refreshPrograms()"
            class="text-blue-600 hover:text-blue-700 font-medium transition-colors"
          >
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>

        <!-- Loading State -->
        <div
          id="loading-state"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
          <div class="skeleton h-96 rounded-2xl"></div>
          <div class="skeleton h-96 rounded-2xl"></div>
          <div class="skeleton h-96 rounded-2xl"></div>
          <div class="skeleton h-96 rounded-2xl"></div>
          <div class="skeleton h-96 rounded-2xl"></div>
          <div class="skeleton h-96 rounded-2xl"></div>
        </div>

        <!-- Programs Grid -->
        <div
          id="programs-grid"
          class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
          <!-- Programs will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
          <div
            class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6"
          >
            <i class="fas fa-search text-gray-400 text-4xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">
            Tidak Ada Program Ditemukan
          </h3>
          <p class="text-gray-600 mb-6">
            Coba ubah filter atau kata kunci pencarian Anda
          </p>
          <button
            onclick="clearAllFilters()"
            class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-all font-medium"
          >
            <i class="fas fa-redo mr-2"></i>Reset Filter
          </button>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden mt-12 flex justify-center">
          <nav class="flex items-center space-x-2">
            <button
              id="prev-page"
              disabled
              class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <div id="page-numbers" class="flex space-x-2">
              <!-- Page numbers will be inserted here -->
            </div>
            <button
              id="next-page"
              class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </nav>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="hero-gradient text-white py-16">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 md:p-12">
          <h2 class="text-3xl md:text-4xl font-bold mb-4">
            Ingin Membuat Program Donasi?
          </h2>
          <p class="text-xl mb-8 text-blue-100">
            Daftarkan UMKM Anda dan dapatkan bantuan dari komunitas peduli
          </p>
          <a
            href="register.html"
            class="inline-block bg-white text-blue-600 px-10 py-4 rounded-lg font-bold text-lg hover:bg-gray-100 transition-all shadow-xl"
          >
            <i class="fas fa-hand-holding-heart mr-2"></i>
            Ajukan Program
          </a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <p class="text-gray-400">
            &copy; 2025 DariKita. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "http://localhost:5000/api";
      let allCauses = [];
      let filteredCauses = [];
      let currentPage = 1;
      const itemsPerPage = 9;

      // Generate placeholder image as data URL
      function generatePlaceholder(text = "DariKita") {
        const canvas = document.createElement("canvas");
        canvas.width = 400;
        canvas.height = 250;
        const ctx = canvas.getContext("2d");

        // Gradient background
        const gradient = ctx.createLinearGradient(0, 0, 400, 250);
        gradient.addColorStop(0, "#667eea");
        gradient.addColorStop(1, "#764ba2");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 250);

        // Text
        ctx.fillStyle = "white";
        ctx.font = "bold 32px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, 200, 125);

        return canvas.toDataURL();
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        checkAuth();
        await loadPrograms();
        setupEventListeners();
      });

      // Check authentication
      function checkAuth() {
        const token = localStorage.getItem("token");
        const userData = localStorage.getItem("userData");

        if (token && userData) {
          document.getElementById("auth-buttons").classList.add("hidden");
          document.getElementById("user-menu").classList.remove("hidden");
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        document
          .getElementById("search-input")
          .addEventListener("input", debounce(applyFilters, 500));
        document
          .getElementById("category-filter")
          .addEventListener("change", applyFilters);
        document
          .getElementById("status-filter")
          .addEventListener("change", applyFilters);
        document
          .getElementById("sort-filter")
          .addEventListener("change", applyFilters);
        document
          .getElementById("logout-btn")
          ?.addEventListener("click", handleLogout);
      }

      // Load all programs
      async function loadPrograms() {
        try {
          showLoading();

          const response = await fetch(`${API_BASE_URL}/causes`);
          const data = await response.json();

          if (data.success && data.data) {
            allCauses = data.data;
            applyFilters();
          } else {
            throw new Error("Failed to load programs");
          }
        } catch (error) {
          console.error("Error loading programs:", error);
          showError();
        }
      }

      // Apply filters
      function applyFilters() {
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();
        const category = document.getElementById("category-filter").value;
        const status = document.getElementById("status-filter").value;
        const sort = document.getElementById("sort-filter").value;

        // Filter
        filteredCauses = allCauses.filter((cause) => {
          const matchSearch =
            !searchTerm ||
            cause.title.toLowerCase().includes(searchTerm) ||
            cause.description.toLowerCase().includes(searchTerm);

          const matchCategory = !category || cause.category === category;
          const matchStatus = !status || cause.status === status;

          return matchSearch && matchCategory && matchStatus;
        });

        // Sort
        switch (sort) {
          case "newest":
            filteredCauses.sort(
              (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            );
            break;
          case "oldest":
            filteredCauses.sort(
              (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
            );
            break;
          case "most-funded":
            filteredCauses.sort((a, b) => b.currentAmount - a.currentAmount);
            break;
          case "urgent":
            filteredCauses.sort((a, b) => {
              const daysA = calculateDaysRemaining(a.deadline);
              const daysB = calculateDaysRemaining(b.deadline);
              return daysA - daysB;
            });
            break;
        }

        updateActiveFilters();
        displayPrograms();
      }

      // Display programs
      function displayPrograms() {
        const grid = document.getElementById("programs-grid");
        const emptyState = document.getElementById("empty-state");
        const resultsInfo = document.getElementById("results-info");
        const loadingState = document.getElementById("loading-state");

        // Hide loading first
        loadingState.classList.add("hidden");

        if (filteredCauses.length === 0) {
          grid.classList.add("hidden");
          emptyState.classList.remove("hidden");
          resultsInfo.textContent = "Tidak ada program ditemukan";
          return;
        }

        emptyState.classList.add("hidden");
        grid.classList.remove("hidden");

        // Pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedCauses = filteredCauses.slice(startIndex, endIndex);

        // Update results info
        resultsInfo.textContent = `Menampilkan ${startIndex + 1}-${Math.min(
          endIndex,
          filteredCauses.length
        )} dari ${filteredCauses.length} program`;

        // Display causes
        grid.innerHTML = paginatedCauses
          .map((cause) => createCauseCard(cause))
          .join("");

        // Update pagination
        updatePagination();
      }

      // Create cause card
      function createCauseCard(cause) {
        const progress = Math.round(
          (cause.currentAmount / cause.targetAmount) * 100
        );
        const daysRemaining = calculateDaysRemaining(cause.deadline);

        const categoryIcons = {
          pendidikan: "fa-graduation-cap",
          kesehatan: "fa-heartbeat",
          sosial: "fa-hands-helping",
          bencana: "fa-house-damage",
          lingkungan: "fa-leaf",
          infrastruktur: "fa-building",
          lainnya: "fa-heart",
        };

        const statusBadges = {
          active:
            '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Aktif</span>',
          completed:
            '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">Selesai</span>',
          closed:
            '<span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">Ditutup</span>',
        };

        const placeholderImg = generatePlaceholder();

        return `
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover">
            <div class="relative">
              <img
                src="${cause.image || placeholderImg}"
                alt="${cause.title}"
                class="w-full h-48 object-cover"
                onerror="this.src='${placeholderImg}'"
              />
              <div class="absolute top-4 right-4">
                ${statusBadges[cause.status] || statusBadges.active}
              </div>
            </div>

            <div class="p-6">
              <div class="flex items-center justify-between mb-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                  <i class="fas ${
                    categoryIcons[cause.category] || "fa-heart"
                  } mr-2"></i>
                  ${
                    cause.category.charAt(0).toUpperCase() +
                    cause.category.slice(1)
                  }
                </span>
                <span class="text-sm text-gray-500">
                  <i class="fas fa-clock mr-1"></i>${daysRemaining} hari
                </span>
              </div>

              <h3 class="text-xl font-bold text-gray-900 mb-2 line-clamp-2">
                ${cause.title}
              </h3>

              <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                ${cause.description}
              </p>

              <!-- Progress Bar -->
              <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Terkumpul</span>
                  <span class="font-bold text-blue-600">${progress}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full transition-all duration-500"
                    style="width: ${Math.min(progress, 100)}%"
                  ></div>
                </div>
                <div class="flex justify-between text-sm mt-2">
                  <span class="text-gray-600">Rp ${cause.currentAmount.toLocaleString(
                    "id-ID"
                  )}</span>
                  <span class="text-gray-600">Rp ${cause.targetAmount.toLocaleString(
                    "id-ID"
                  )}</span>
                </div>
              </div>

              <!-- Donors -->
              <div class="flex items-center text-sm text-gray-600 mb-4">
                <i class="fas fa-users mr-2"></i>
                <span>${cause.totalDonors || 0} donatur</span>
              </div>

              <!-- Action Button -->
              <a
                href="cause-detail.html?id=${cause._id}"
                class="block w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white text-center py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-md"
              >
                <i class="fas fa-heart mr-2"></i>Donasi Sekarang
              </a>
            </div>
          </div>
        `;
      }

      // Calculate days remaining
      function calculateDaysRemaining(deadline) {
        const now = new Date();
        const end = new Date(deadline);
        const diff = end - now;
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        return Math.max(0, days);
      }

      // Update active filters display
      function updateActiveFilters() {
        const container = document.getElementById("active-filters");
        const filters = [];

        const search = document.getElementById("search-input").value;
        const category = document.getElementById("category-filter").value;
        const status = document.getElementById("status-filter").value;

        if (search)
          filters.push({
            type: "search",
            value: search,
            label: `Pencarian: "${search}"`,
          });
        if (category)
          filters.push({
            type: "category",
            value: category,
            label: `Kategori: ${category}`,
          });
        if (status)
          filters.push({
            type: "status",
            value: status,
            label: `Status: ${status}`,
          });

        if (filters.length === 0) {
          container.classList.add("hidden");
          return;
        }

        container.classList.remove("hidden");
        container.innerHTML = filters
          .map(
            (filter) => `
          <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
            ${filter.label}
            <button onclick="removeFilter('${filter.type}')" class="ml-2 hover:text-blue-900">
              <i class="fas fa-times"></i>
            </button>
          </span>
        `
          )
          .join("");
      }

      // Remove specific filter
      function removeFilter(type) {
        switch (type) {
          case "search":
            document.getElementById("search-input").value = "";
            break;
          case "category":
            document.getElementById("category-filter").value = "";
            break;
          case "status":
            document.getElementById("status-filter").value = "";
            break;
        }
        applyFilters();
      }

      // Clear all filters
      function clearAllFilters() {
        document.getElementById("search-input").value = "";
        document.getElementById("category-filter").value = "";
        document.getElementById("status-filter").value = "active";
        document.getElementById("sort-filter").value = "newest";
        applyFilters();
      }

      // Update pagination
      function updatePagination() {
        const totalPages = Math.ceil(filteredCauses.length / itemsPerPage);

        if (totalPages <= 1) {
          document.getElementById("pagination").classList.add("hidden");
          return;
        }

        document.getElementById("pagination").classList.remove("hidden");

        // Update prev/next buttons
        document.getElementById("prev-page").disabled = currentPage === 1;
        document.getElementById("next-page").disabled =
          currentPage === totalPages;

        // Generate page numbers
        const pageNumbers = document.getElementById("page-numbers");
        pageNumbers.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          if (
            i === 1 ||
            i === totalPages ||
            (i >= currentPage - 1 && i <= currentPage + 1)
          ) {
            const button = document.createElement("button");
            button.textContent = i;
            button.className = `px-4 py-2 border rounded-lg transition-all ${
              i === currentPage
                ? "bg-blue-600 text-white border-blue-600"
                : "border-gray-300 text-gray-700 hover:bg-gray-50"
            }`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            const dots = document.createElement("span");
            dots.textContent = "...";
            dots.className = "px-2 text-gray-500";
            pageNumbers.appendChild(dots);
          }
        }

        // Prev/Next handlers
        document.getElementById("prev-page").onclick = () =>
          goToPage(currentPage - 1);
        document.getElementById("next-page").onclick = () =>
          goToPage(currentPage + 1);
      }

      // Go to page
      function goToPage(page) {
        currentPage = page;
        displayPrograms();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Refresh programs
      async function refreshPrograms() {
        currentPage = 1;
        await loadPrograms();
      }

      // Debounce utility
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Logout
      function handleLogout() {
        if (confirm("Apakah Anda yakin ingin keluar?")) {
          localStorage.clear();
          window.location.href = "index.html";
        }
      }

      // UI States
      function showLoading() {
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("programs-grid").classList.add("hidden");
        document.getElementById("empty-state").classList.add("hidden");
      }

      function hideLoading() {
        document.getElementById("loading-state").classList.add("hidden");
      }

      function showError() {
        hideLoading();
        document.getElementById("empty-state").classList.remove("hidden");
        document.getElementById("results-info").innerHTML =
          '<i class="fas fa-exclamation-circle text-red-500 mr-2"></i>Gagal memuat program';
      }
    </script>

    <script src="js/utils.js"></script>
  </body>
</html>
